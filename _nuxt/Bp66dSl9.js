import{x as se,G as I,O as L,bq as ie,bY as Z,bZ as G,b_ as P,r as q,o as Y,aR as oe,b$ as A,b as ue,c0 as le,bd as K,al as E,c1 as ce,c2 as fe,z as de,d as me,w as pe,A as ye,aZ as ve,n as he,C as H,ap as be,c3 as Ee,c4 as ge}from"#entry";function we(a){return"schema"in a&&typeof a.coercer=="function"&&typeof a.validator=="function"&&typeof a.refiner=="function"}function Se(a){return"~standard"in a}async function Fe(a,i){const l=await i["~standard"].validate(a);return l.issues?{errors:l.issues?.map(r=>({name:r.path?.map(o=>typeof o=="object"?o.key:o).join(".")||"",message:r.message}))||[],result:null}:{errors:null,result:l.value}}async function Ie(a,i){const[l,r]=i.validate(a);return l?{errors:l.failures().map(h=>({message:h.message,name:h.path.join(".")})),result:null}:{errors:null,result:r}}function qe(a,i){if(Se(i))return Fe(a,i);if(we(i))return Ie(a,i);throw new Error("Form validation failed: Unsupported form schema")}function xe(a,i){return i?i.split(".").reduce((r,o)=>r?.[o],a):a}function je(a,i,l){if(!i)return Object.assign(a,l);if(!a)return a;const r=i.split(".");let o=a;for(let y=0;y<r.length-1;y++){const c=r[y];(o[c]===void 0||o[c]===null)&&(y+1<r.length&&!Number.isNaN(Number(r[y+1]))?o[c]=[]:o[c]={}),o=o[c]}const h=r[r.length-1];return o[h]=l,a}class x extends Error{formId;errors;constructor(i,l){super("Form validation exception"),this.formId=i,this.errors=l,Object.setPrototypeOf(this,x.prototype)}}const Ne={base:""},Ae={__name:"UForm",props:{id:{type:[String,Number],required:!1},schema:{type:null,required:!1},state:{type:null,required:!1},validate:{type:Function,required:!1},validateOn:{type:Array,required:!1,default(){return["input","blur","change"]}},disabled:{type:Boolean,required:!1},name:{type:null,required:!1},validateOnInputDelay:{type:Number,required:!1,default:300},transform:{type:null,required:!1,default:()=>!0},nested:{type:null,required:!1},loadingAuto:{type:Boolean,required:!1,default:!0},class:{type:null,required:!1},onSubmit:{type:Function,required:!1}},emits:["submit","error"],setup(a,{expose:i,emit:l}){const r=a,o=l,h=se(),y=I(()=>L({extend:L(Ne),...h.ui?.form||{}})),c=r.id??ie(),B=le(`form-${c}`),R=r.nested?.toString()===""||r.nested===!0,g=R&&Z(G,void 0),k=R?Z(P,void 0):void 0,w=I(()=>k?.value?r.name?xe(k.value,r.name):k.value:r.state);E(G,B),E(P,w);const S=q(new Map);Y(async()=>{g&&(await oe(),g.emit({type:"attach",validate:F,formId:c,name:r.name,api:$}))}),ue(()=>{B.reset(),g&&g.emit({type:"detach",formId:c})}),Y(async()=>{B.on(async e=>{e.type==="attach"?S.value.set(e.formId,{validate:e.validate,name:e.name,api:e.api}):e.type==="detach"?S.value.delete(e.formId):r.validateOn?.includes(e.type)&&!v.value&&(e.type!=="input"?await F({name:e.name,silent:!0,nested:!1}):(e.eager||_.has(e.name))&&await F({name:e.name,silent:!0,nested:!1})),e.type==="blur"&&_.add(e.name),(e.type==="change"||e.type==="input"||e.type==="blur"||e.type==="focus")&&C.add(e.name),(e.type==="change"||e.type==="input")&&N.add(e.name)})});const u=q([]);E(Ee,u);const j=q({});E(ge,j);const N=K(new Set),C=K(new Set),_=K(new Set);function W(e){return e.map(t=>({...t,id:t?.name?j.value[t.name]?.id:void 0}))}const O=q(null);async function J(){let e=r.validate?await r.validate(w.value)??[]:[];if(r.schema){const{errors:t,result:n}=await qe(w.value,r.schema);t?e=e.concat(t):O.value=n}return W(e)}async function F(e={silent:!1,nested:!1,transform:!1}){const t=e.name&&!Array.isArray(e.name)?[e.name]:e.name;let n=[],s=[];if(!t&&e.nested){const p=Array.from(S.value.values()).map(m=>Q(m,e)),d=await Promise.all(p);s=d.filter(m=>m.error).flatMap(m=>m.error.errors.map(ae=>V(ae,m.name))),n=d.filter(m=>m.output!==void 0)}const b=[...await J(),...s];if(t?u.value=ne(b,t):u.value=b,u.value?.length){if(e.silent)return!1;throw new x(c,u.value)}return e.transform?(n.forEach(p=>{p.name?je(O.value,p.name,p.output):Object.assign(O.value,p.output)}),O.value??w.value):w.value}const v=q(!1);E(ce,A(v));async function D(e){v.value=r.loadingAuto&&!0;const t=e;try{t.data=await F({nested:!0,transform:r.transform}),await r.onSubmit?.(t),N.clear()}catch(n){if(!(n instanceof x))throw n;const s={...t,errors:n.errors};o("error",s)}finally{v.value=!1}}const M=I(()=>r.disabled||v.value);E(fe,I(()=>({disabled:M.value,validateOnInputDelay:r.validateOnInputDelay})));async function Q(e,t){try{const n=await e.validate({...t,silent:!1});return{name:e.name,output:n}}catch(n){if(!(n instanceof x))throw n;return{name:e.name,error:n}}}function V(e,t){return!t||!e.name?e:{...e,name:t+"."+e.name}}function X(e,t){const n=t+".",s=e?.name?.startsWith(n)?e.name.substring(n.length):e.name;return{...e,name:s}}function ee(e,t){return t?e.filter(n=>n?.name?.startsWith(t+".")).map(n=>X(n,t)):e}function T(e){return e.api.getErrors().map(t=>e.name?{...t,name:e.name+"."+t.name}:t)}function z(e,t){return!e||!t?!0:e instanceof RegExp?e.test(t):t===e||typeof e=="string"&&e.startsWith(t+".")}function te(e,t){if(!e||e instanceof RegExp)return e;if(t!==e)return typeof e=="string"&&e.startsWith(t+".")?e.substring(t.length+1):e}function ne(e,t){const n=new Set(t),s=t.map(d=>j.value?.[d]?.pattern).filter(Boolean),f=d=>d.name?n.has(d.name)?!0:s.some(m=>m.test(d.name)):!1,b=u.value.filter(d=>!f(d)),p=e.filter(f);return[...b,...p]}function re(e,t){return e.filter(n=>t instanceof RegExp?!(n.name&&t.test(n.name)):!n.name||n.name!==t)}function U(e){return!e.name||!!j.value[e.name]}const $={validate:F,errors:u,setErrors(e,t){const n=W(e.filter(U)),s=[];for(const f of S.value.values())if(z(t,f.name)){const b=ee(e,f.name);f.api.setErrors(b,te(t,f.name||"")),s.push(...T(f))}if(t){const f=re(u.value,t);u.value=[...f,...n,...s]}else u.value=[...n,...s]},async submit(){await D(new Event("submit"))},getErrors(e){return e?u.value.filter(t=>e instanceof RegExp?t.name&&e.test(t.name):t.name===e):u.value},clear(e){const t=e?u.value.filter(s=>U(s)&&(e instanceof RegExp?!(s.name&&e.test(s.name)):s.name!==e)):[],n=[];for(const s of S.value.values())z(e,s.name)&&s.api.clear(),n.push(...T(s));u.value=[...t,...n]},disabled:M,loading:v,dirty:I(()=>!!N.size),dirtyFields:A(N),blurredFields:A(_),touchedFields:A(C)};return i($),(e,t)=>(me(),de(be(H(g)?"div":"form"),{id:H(c),class:he(y.value({class:r.class})),onSubmit:ve(D,["prevent"])},{default:pe(()=>[ye(e.$slots,"default",{errors:u.value,loading:v.value})]),_:3},40,["id","class"]))}};export{Ae as _};
